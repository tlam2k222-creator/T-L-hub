--[[ 
    TLAM HUB - MINI PLUS FINAL V2 (FIXED MINIMIZE & ZERO GAP)
]]

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- BIẾN HỆ THỐNG
local aimbotEnabled, espEnabled, showPov, isShooting = false, false, false, false
local aimMode = "OnAttack" 
local fovRadius, currentSpeed = 180, 16
local FIXED_SNAP_SPEED = 0.35 
local isDraggingSlider = false 

-- 1. POV CIRCLE
local fovCircle = Drawing.new("Circle")
fovCircle.Thickness = 1; fovCircle.NumSides = 60; fovCircle.Radius = fovRadius
fovCircle.Visible = false; fovCircle.Color = Color3.new(1,1,1); fovCircle.Transparency = 0.5

-- 2. HỆ THỐNG ESP (BOX)
local espCache = {}
local function createEsp(player)
    if player == LocalPlayer then return end
    local lines = {
        TL1 = Drawing.new("Line"), TL2 = Drawing.new("Line"),
        TR1 = Drawing.new("Line"), TR2 = Drawing.new("Line"),
        BL1 = Drawing.new("Line"), BL2 = Drawing.new("Line"),
        BR1 = Drawing.new("Line"), BR2 = Drawing.new("Line")
    }
    for _, l in pairs(lines) do l.Thickness = 1; l.Color = Color3.new(1,1,1); l.Visible = false end
    espCache[player] = lines
end

local function updateEsp()
    for player, lines in pairs(espCache) do
        local char = player.Character
        if espEnabled and char and char:FindFirstChild("HumanoidRootPart") and char.Humanoid.Health > 0 then
            local pos, onScreen = Camera:WorldToViewportPoint(char.HumanoidRootPart.Position)
            if onScreen then
                local sX, sY = 1800 / pos.Z, 2500 / pos.Z
                local x, y = pos.X, pos.Y
                local edgeLen = sX * 0.25
                lines.TL1.From = Vector2.new(x-sX/2, y-sY/2); lines.TL1.To = Vector2.new(x-sX/2 + edgeLen, y-sY/2)
                lines.TL2.From = Vector2.new(x-sX/2, y-sY/2); lines.TL2.To = Vector2.new(x-sX/2, y-sY/2 + edgeLen)
                lines.TR1.From = Vector2.new(x+sX/2, y-sY/2); lines.TR1.To = Vector2.new(x+sX/2 - edgeLen, y-sY/2)
                lines.TR2.From = Vector2.new(x+sX/2, y-sY/2); lines.TR2.To = Vector2.new(x+sX/2, y-sY/2 + edgeLen)
                lines.BL1.From = Vector2.new(x-sX/2, y+sY/2); lines.BL1.To = Vector2.new(x-sX/2 + edgeLen, y+sY/2)
                lines.BL2.From = Vector2.new(x-sX/2, y+sY/2); lines.BL2.To = Vector2.new(x-sX/2, y+sY/2 - edgeLen)
                lines.BR1.From = Vector2.new(x+sX/2, y+sY/2); lines.BR1.To = Vector2.new(x+sX/2 - edgeLen, y+sY/2)
                lines.BR2.From = Vector2.new(x+sX/2, y+sY/2); lines.BR2.To = Vector2.new(x+sX/2, y+sY/2 - edgeLen)
                for _, l in pairs(lines) do l.Visible = true end
            else
                for _, l in pairs(lines) do l.Visible = false end
            end
        else
            for _, l in pairs(lines) do l.Visible = false end
        end
    end
end

-- 3. GIAO DIỆN (HEIGHT 210 - CỰC GỌN)
local screenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
screenGui.Name = "TLAM_MiniFinal_V2"
screenGui.ResetOnSpawn = false

local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 140, 0, 205) -- Chiều cao tối ưu sạch sẽ
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(12, 12, 12)
mainFrame.Active = true
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 6)
Instance.new("UIStroke", mainFrame).Color = Color3.fromRGB(0, 180, 255)

local title = Instance.new("TextLabel", mainFrame)
title.Size = UDim2.new(1, 0, 0, 25); title.Text = "TLAM HUB"; title.TextColor3 = Color3.fromRGB(0, 180, 255); title.Font = "GothamBold"; title.BackgroundTransparency = 1; title.TextSize = 10

-- NÚT THU NHỎ & TẮT (VỊ TRÍ MỚI ĐỂ KHÔNG BỊ MẤT)
local killBtn = Instance.new("TextButton", mainFrame); killBtn.Size = UDim2.new(0, 20, 0, 20); killBtn.Position = UDim2.new(1, -22, 0, 3); killBtn.Text = "×"; killBtn.TextColor3 = Color3.fromRGB(255, 50, 50); killBtn.BackgroundTransparency = 1; killBtn.TextSize = 18
local minBtn = Instance.new("TextButton", mainFrame); minBtn.Size = UDim2.new(0, 20, 0, 20); minBtn.Position = UDim2.new(1, -40, 0, 3); minBtn.Text = "-"; minBtn.TextColor3 = Color3.new(1, 1, 1); minBtn.BackgroundTransparency = 1; minBtn.TextSize = 22

local openBtn = Instance.new("ImageButton", screenGui); openBtn.Size = UDim2.new(0, 35, 0, 35); openBtn.Position = UDim2.new(0, 10, 0.5, 0); openBtn.Visible = false; openBtn.Image = "rbxassetid://6031091000"; openBtn.BackgroundColor3 = Color3.fromRGB(15, 15, 15); Instance.new("UICorner", openBtn)

minBtn.MouseButton1Click:Connect(function() mainFrame.Visible = false; openBtn.Visible = true end)
openBtn.MouseButton1Click:Connect(function() mainFrame.Visible = true; openBtn.Visible = false end)
killBtn.MouseButton1Click:Connect(function() if fovCircle then fovCircle:Remove() end for _, l in pairs(espCache) do for _, line in pairs(l) do line:Remove() end end screenGui:Destroy() end)

-- HÀM TẠO NÚT
local function createBtn(yPos, text, status, callback)
    local btn = Instance.new("TextButton", mainFrame); btn.Size = UDim2.new(0.9, 0, 0, 22); btn.Position = UDim2.new(0.05, 0, 0, yPos); btn.Font = "GothamMedium"; btn.TextSize = 9; btn.TextColor3 = Color3.new(1,1,1); Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 4)
    local function updateColor(isOn)
        btn.BackgroundColor3 = isOn and Color3.fromRGB(0, 100, 180) or Color3.fromRGB(30, 30, 35)
        btn.Text = text .. (isOn and ": ON" or ": OFF")
    end
    updateColor(status)
    btn.MouseButton1Click:Connect(function() updateColor(callback()) end)
end

-- HÀM TẠO SLIDER
local function createSlider(yPos, label, min, max, default, callback)
    local box = Instance.new("Frame", mainFrame); box.Size = UDim2.new(0.94, 0, 0, 30); box.Position = UDim2.new(0.03, 0, 0, yPos); box.BackgroundTransparency = 1
    local txt = Instance.new("TextLabel", box); txt.Size = UDim2.new(1, 0, 0, 12); txt.Text = label..": "..default; txt.TextColor3 = Color3.new(0.8,0.8,0.8); txt.BackgroundTransparency = 1; txt.TextSize = 8; txt.Font = "Gotham"
    local bar = Instance.new("Frame", box); bar.Size = UDim2.new(1, 0, 0, 5); bar.Position = UDim2.new(0, 0, 0, 16); bar.BackgroundColor3 = Color3.fromRGB(35, 35, 40); Instance.new("UICorner", bar)
    local fill = Instance.new("Frame", bar); fill.Size = UDim2.new((default-min)/(max-min), 0, 1, 0); fill.BackgroundColor3 = Color3.fromRGB(0, 180, 255); Instance.new("UICorner", fill)
    local knob = Instance.new("Frame", bar); knob.Size = UDim2.new(0, 10, 0, 10); knob.Position = UDim2.new((default-min)/(max-min), 0, 0.5, 0); knob.AnchorPoint = Vector2.new(0.5, 0.5); knob.BackgroundColor3 = Color3.new(1,1,1); Instance.new("UICorner", knob)

    local dragging = false
    local function update(input)
        local posPercent = math.clamp((input.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
        knob.Position = UDim2.new(posPercent, 0, 0.5, 0); fill.Size = UDim2.new(posPercent, 0, 1, 0)
        local value = math.floor(min + (posPercent * (max - min))); txt.Text = label..": "..value; callback(value)
    end
    box.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = true; isDraggingSlider = true; update(input) end end)
    UserInputService.InputChanged:Connect(function(input) if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then update(input) end end)
    UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false; isDraggingSlider = false end end)
end

-- KHỞI TẠO (SẮP XẾP LẠI KHOẢNG CÁCH)
createBtn(28, "AIMBOT", aimbotEnabled, function() aimbotEnabled = not aimbotEnabled; return aimbotEnabled end)
createBtn(52, "ESP", espEnabled, function() espEnabled = not espEnabled; return espEnabled end)
createBtn(76, "FOV", showPov, function() showPov = not showPov; return showPov end)

local modeBtn = Instance.new("TextButton", mainFrame); modeBtn.Size = UDim2.new(0.9, 0, 0, 22); modeBtn.Position = UDim2.new(0.05, 0, 0, 100); modeBtn.BackgroundColor3 = Color3.fromRGB(40, 30, 60); modeBtn.TextColor3 = Color3.new(1,1,1); modeBtn.Font = "GothamMedium"; modeBtn.TextSize = 9; modeBtn.Text = "MODE: ATTACK"; Instance.new("UICorner", modeBtn)
modeBtn.MouseButton1Click:Connect(function()
    aimMode = (aimMode == "OnAttack" and "Always" or "OnAttack")
    modeBtn.Text = "MODE: "..(aimMode == "OnAttack" and "ATTACK" or "ALWAYS")
    modeBtn.BackgroundColor3 = (aimMode == "OnAttack" and Color3.fromRGB(40, 30, 60) or Color3.fromRGB(80, 20, 20))
end)

createSlider(128, "RADIUS", 0, 500, 180, function(v) fovRadius = v end)
createSlider(162, "SPEED", 16, 200, 16, function(v) currentSpeed = v end) -- Min 16

-- LOGIC VẬN HÀNH (DƯỚI ĐÂY)
UserInputService.InputBegan:Connect(function(i, g) if not g and (i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch) then isShooting = true end end)
UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then isShooting = false end end)

local function getTarget()
    local t, m = nil, fovRadius
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Head") and p.Character.Humanoid.Health > 0 then
            local pos, screen = Camera:WorldToViewportPoint(p.Character.Head.Position)
            if screen then
                local mag = (Vector2.new(pos.X, pos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                if mag < m then m = mag; t = p.Character.Head end
            end
        end
    end
    return t
end

RunService.RenderStepped:Connect(function()
    updateEsp()
    if fovCircle then fovCircle.Visible = showPov; fovCircle.Radius = fovRadius; fovCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2) end
    if aimbotEnabled and (aimMode == "Always" or (aimMode == "OnAttack" and isShooting)) then
        local t = getTarget()
        if t then Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position, t.Position), FIXED_SNAP_SPEED) end
    end
    pcall(function() if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then LocalPlayer.Character.Humanoid.WalkSpeed = currentSpeed end end)
end)

local function drag(o)
    local dragging, inputStart, startPos
    o.InputBegan:Connect(function(i) if (i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch) and not isDraggingSlider then dragging = true; inputStart = i.Position; startPos = o.Position end end)
    UserInputService.InputChanged:Connect(function(i) if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then local delta = i.Position - inputStart; o.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y) end end)
    UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then dragging = false end end)
end
drag(mainFrame); drag(openBtn)

for _, p in ipairs(Players:GetPlayers()) do createEsp(p) end
Players.PlayerAdded:Connect(createEsp)
